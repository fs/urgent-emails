#!/usr/bin/env ruby

require 'optparse'
require 'ostruct'
require 'openssl'
require 'base64'

options = OpenStruct.new decrypt: false,
  file_path: File.expand_path('../lib/emails.text', __dir__)

OptionParser.new do |opts|
  opts.on '-k',
    '--key_base64 KEY',
    'Require the KEY encoded with base64 before executing your script' do |key|

    options.key_env = key
  end

  opts.on '-f',
    '--file FILE',
    "Input file path for encrypting, default is #{options.file_path}" do |path|

    options.file_path = path
  end

  opts.on('-d', '--decrypt', 'Decrypt input file') do
    options.decrypt = true
  end
end.parse!

key = OpenSSL::PKey::RSA.new(Base64.decode64(options.key_env))

if options.decrypt
  File.write options.file_path,
    key.private_decrypt(Base64.decode64(File.read("#{options.file_path}.encrypted")))
else
  File.write "#{options.file_path}.encrypted",
    Base64.encode64(key.public_encrypt(File.read(options.file_path)))
end
